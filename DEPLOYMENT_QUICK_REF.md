# VPS Deployment Quick Reference

## âœ… Configuration Summary

### Domain & Ports
- **Domain:** penguin-lrm-analysis.duckdns.org
- **Port Offset:** +7000 (to avoid conflicts)

### External Ports (Host â†’ Container)
```
Nginx:       80 â†’ 80 (HTTP)
Nginx:       443 â†’ 443 (HTTPS)
MongoDB:     34017 â†’ 27017 (+7000 offset)
Cassandra:   16042 â†’ 9042 (+7000 offset)
Redis:       13379 â†’ 6379 (+7000 offset)
```

### Internal Network
All services communicate internally via Docker network:
- API: `http://api:8000`
- Frontend: `http://frontend:80`
- MongoDB: `mongodb://mongodb:27017`
- Cassandra: `cassandra:9042`
- Redis: `redis:6379`

---

## ğŸš€ Quick Deployment

### 1. Prepare VPS
```bash
ssh root@<YOUR_VPS_IP>
curl -fsSL https://get.docker.com | sh
apt install docker-compose git certbot -y
```

### 2. Deploy Project
```bash
git clone <your-repo> penguins-project
cd penguins-project
docker-compose -f docker-compose.prod.yml up -d
```

### 3. Configure Firewall
```bash
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw enable
```

### 4. Setup SSL (Optional)
```bash
docker-compose -f docker-compose.prod.yml down
certbot certonly --standalone -d penguin-lrm-analysis.duckdns.org
mkdir -p nginx/ssl
cp /etc/letsencrypt/live/penguin-lrm-analysis.duckdns.org/*.pem nginx/ssl/
```

Edit `nginx/nginx.conf` to uncomment HTTPS block, then:
```bash
docker-compose -f docker-compose.prod.yml up -d
```

---

## ğŸŒ Access URLs

### After HTTP deployment:
- Frontend: http://penguin-lrm-analysis.duckdns.org
- API Docs: http://penguin-lrm-analysis.duckdns.org/docs
- API Health: http://penguin-lrm-analysis.duckdns.org/api/health

### After HTTPS setup:
- Frontend: https://penguin-lrm-analysis.duckdns.org
- API Docs: https://penguin-lrm-analysis.duckdns.org/docs
- API Health: https://penguin-lrm-analysis.duckdns.org/api/health

---

## ğŸ”§ Common Commands

### Service Management
```bash
# Start all services
docker-compose -f docker-compose.prod.yml up -d

# Stop all services
docker-compose -f docker-compose.prod.yml down

# View logs
docker-compose -f docker-compose.prod.yml logs -f

# Restart a service
docker restart penguins-nginx
docker restart penguins-api

# Rebuild after code changes
docker-compose -f docker-compose.prod.yml up -d --build
```

### Monitoring
```bash
# View all containers
docker ps

# View resource usage
docker stats

# Check specific logs
docker logs -f penguins-nginx
docker logs -f penguins-api
docker logs penguins-mongo
```

### Health Checks
```bash
# Check MongoDB
docker exec -it penguins-mongo mongosh --eval "db.adminCommand('ping')"

# Check Cassandra
docker exec -it penguins-cassandra nodetool status

# Check Redis
docker exec -it penguins-redis redis-cli ping

# Check API
curl http://localhost/api/health
```

---

## ğŸ“ Project Structure

```
penguins-project/
â”œâ”€â”€ docker-compose.prod.yml  # Production configuration
â”œâ”€â”€ backend/                 # FastAPI application
â”œâ”€â”€ frontend/                # React application
â”œâ”€â”€ data/                    # Initialization scripts
â””â”€â”€ nginx/                   # â† NEW
    â”œâ”€â”€ Dockerfile           # Nginx Docker image
    â”œâ”€â”€ nginx.conf           # Nginx configuration
    â””â”€â”€ ssl/                 # SSL certificates
        â”œâ”€â”€ README.md        # SSL setup instructions
        â”œâ”€â”€ .gitignore       # Prevent committing certs
        â”œâ”€â”€ fullchain.pem    # (generated by certbot)
        â””â”€â”€ privkey.pem      # (generated by certbot)
```

---

## ğŸ›¡ï¸ Security Checklist

- [x] Firewall configured (UFW)
- [x] Databases not directly exposed (only via offset ports if needed)
- [x] Nginx rate limiting configured
- [x] SSL certificates from Let's Encrypt
- [x] Security headers in Nginx
- [ ] Regular backups configured
- [ ] DuckDNS auto-update cron job
- [ ] SSL certificate auto-renewal

---

## ğŸ” Troubleshooting

### Port 80 already in use
```bash
netstat -tulpn | grep :80
kill -9 <PID>
# Or stop system nginx: systemctl stop nginx
```

### Domain not resolving
```bash
nslookup penguin-lrm-analysis.duckdns.org
# Update DuckDNS:
curl "https://www.duckdns.org/update?domains=penguin-lrm-analysis&token=YOUR_TOKEN&ip="
```

### 502 Bad Gateway
```bash
# API probably crashed
docker logs penguins-api
docker restart penguins-api
```

### Cannot access externally but works locally
```bash
# Firewall issue
ufw status
ufw allow 80/tcp
ufw allow 443/tcp
```

---

## ğŸ“‹ Volumes

Persistent data is stored in Docker volumes:
```bash
# List volumes
docker volume ls | grep penguins

# Backup a volume
docker run --rm -v penguins_mongo_data:/data -v $(pwd):/backup \
  ubuntu tar czf /backup/mongo_backup.tar.gz /data

# Remove all volumes (âš ï¸ DATA LOSS!)
docker-compose -f docker-compose.prod.yml down -v
```

---

## ğŸ“š Documentation

- Full Guide: [DEPLOYMENT_VPS.md](DEPLOYMENT_VPS.md)
- SSL Setup: [nginx/ssl/README.md](nginx/ssl/README.md)
- Project Info: [README.md](README.md)

---

**Last Updated:** 2026-02-20
